# Reusable workflow: Validate repository structure and spec format.
# Called by ci.yml and spec-validation.yml to avoid duplicating validation logic.
# Template consumers can also call this from their own workflows.
#
# Usage in a caller workflow:
#   jobs:
#     validate:
#       uses: ./.github/workflows/validate-repo.yml

name: Validate Repository

on:
  workflow_call:
    inputs:
      check-specs:
        description: "Whether to validate spec file format"
        required: false
        default: true
        type: boolean

jobs:
  structure:
    name: Repository Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required directories
        run: |
          required_dirs=(
            ".github/agents"
            ".github/workflows"
            ".github/ISSUE_TEMPLATE"
            "specs"
            "tasks"
          )

          missing=()
          for dir in "${required_dirs[@]}"; do
            [ -d "$dir" ] || missing+=("$dir")
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "❌ Missing directories:"
            printf '  %s\n' "${missing[@]}"
            exit 1
          fi
          echo "✅ All required directories exist"

      - name: Check required files
        run: |
          required_files=(
            "README.md"
            "specs/README.md"
            "specs/SPEC_TEMPLATE.md"
            "tasks/README.md"
            "tasks/TASK_TEMPLATE.md"
            ".github/PULL_REQUEST_TEMPLATE.md"
          )

          missing=()
          for file in "${required_files[@]}"; do
            [ -f "$file" ] || missing+=("$file")
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "❌ Missing files:"
            printf '  %s\n' "${missing[@]}"
            exit 1
          fi
          echo "✅ All required files exist"

      - name: Validate spec format
        if: ${{ inputs.check-specs }}
        run: |
          shopt -s nullglob
          specs=(specs/SPEC-[0-9]*.md)

          if [ ${#specs[@]} -eq 0 ]; then
            echo "ℹ️  No spec files to validate"
            exit 0
          fi

          errors=0
          for spec in "${specs[@]}"; do
            missing=""
            for section in "## Overview" "## Requirements" "## Acceptance Criteria" "## Status"; do
              grep -q "$section" "$spec" || missing="$missing $section"
            done
            if [ -z "$missing" ]; then
              echo "  ✅ $(basename "$spec")"
            else
              echo "  ❌ $(basename "$spec"): missing$missing"
              errors=$((errors + 1))
            fi
          done

          [ "$errors" -eq 0 ] || exit 1

      - name: Check trailing whitespace
        run: |
          if git grep -I --line-number '[[:space:]]$' -- '*.md' '*.yml' '*.yaml' '*.json'; then
            echo "❌ Found trailing whitespace"
            exit 1
          fi
          echo "✅ No trailing whitespace"
