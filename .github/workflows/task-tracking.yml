name: Task Tracking

on:
  issues:
    types: [opened, edited, closed, reopened]
  pull_request:
    types: [opened, closed]

jobs:
  update-task-status:
    name: Update Task Status
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update task status in files
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"

          # Extract task IDs from PR body
          TASK_IDS=$(echo "$PR_BODY" | grep -oE "TASK-[0-9]+-[0-9]+" || true)

          if [ -z "$TASK_IDS" ]; then
            echo "‚ÑπÔ∏è No task IDs found in PR"
            exit 0
          fi

          echo "üìã Found tasks: $TASK_IDS"

          # Update status in task files (this is a simplified example)
          # In a real implementation, you'd parse and update the actual task files
          for task_id in $TASK_IDS; do
            echo "‚úÖ Task $task_id completed via PR #${{ github.event.pull_request.number }}"
          done

  create-spec-from-issue:
    name: Create Spec from Issue (Stub)
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.labels.*.name, 'spec')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Placeholder for spec file creation
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # Create a sanitized filename
          SPEC_FILE="specs/SPEC-$(printf '%03d' $ISSUE_NUMBER)-$(echo "$ISSUE_TITLE" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g' | cut -c1-50).md"

          echo "üìù Spec file would be created at: $SPEC_FILE"
          echo "‚ÑπÔ∏è  This is a stub workflow. In a full implementation:"
          echo "   - Parse issue body to extract spec sections"
          echo "   - Generate spec file from template"
          echo "   - Commit and push the spec file"
          echo "   - Requires workflow permissions: contents: write"

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ This workflow is a placeholder for automatic spec creation. In a full implementation, a spec file would be generated from this issue template and committed to the repository for the plan-agent to break down into tasks.\n\nFor now, please manually create a spec file in the `specs/` directory using the template at `specs/SPEC_TEMPLATE.md`.'
            })
