name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Repository
    uses: ./.github/workflows/validate-repo.yml

  lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'
        continue-on-error: true

  validate-agents:
    name: Validate Agent Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate agent JSON files
        run: |
          shopt -s nullglob
          agent_files=(.github/agents/*.json)

          if [ ${#agent_files[@]} -eq 0 ]; then
            echo "âš ï¸  No JSON agent configuration files found (this is OK if using markdown agents)"
            exit 0
          fi

          echo "ğŸ¤– Validating agent configurations..."

          for agent_file in "${agent_files[@]}"; do
            if [ ! -f "$agent_file" ]; then
              continue
            fi

            echo "Checking $agent_file..."

            # Validate JSON syntax
            if ! jq empty "$agent_file" 2>/dev/null; then
              echo "âŒ $agent_file is not valid JSON"
              exit 1
            fi

            # Check required fields
            required_fields=("name" "description" "instructions")
            for field in "${required_fields[@]}"; do
              if ! jq -e ".$field" "$agent_file" > /dev/null 2>&1; then
                echo "âŒ $agent_file is missing required field: $field"
                exit 1
              fi
            done

            echo "âœ… $agent_file is valid"
          done

          echo "âœ… All agent configurations are valid"
