name: Spec Validation

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-repo:
    name: Validate Repository
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/validate-repo.yml
    with:
      check-specs: true

  validate-spec-linking:
    name: Validate Spec Linking
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR links to spec or issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Allow PRs without body (like initial setup PRs)
          if [ -z "$PR_BODY" ]; then
            echo "⚠️  PR has no description - skipping validation"
            exit 0
          fi

          if echo "$PR_BODY" | grep -qE "(Closes|Fixes|Resolves|Related to) #[0-9]+"; then
            echo "✅ PR is linked to an issue or spec"
            exit 0
          elif echo "$PR_BODY" | grep -qE "SPEC-[0-9]+"; then
            echo "✅ PR references a spec"
            exit 0
          else
            echo "⚠️  PR should link to an issue (Closes #XX) or reference a spec (SPEC-XX)"
            echo "This ensures traceability in SPEC-driven development"
            echo "Allowing PR to proceed for initial setup..."
            exit 0
          fi
