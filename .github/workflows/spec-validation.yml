name: Spec Validation

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-spec-linking:
    name: Validate Spec Linking
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR links to spec or issue
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Allow PRs without body (like initial setup PRs)
          if [ -z "$PR_BODY" ]; then
            echo "‚ö†Ô∏è  PR has no description - skipping validation"
            exit 0
          fi

          if echo "$PR_BODY" | grep -qE "(Closes|Fixes|Resolves|Related to) #[0-9]+"; then
            echo "‚úÖ PR is linked to an issue or spec"
            exit 0
          elif echo "$PR_BODY" | grep -qE "SPEC-[0-9]+"; then
            echo "‚úÖ PR references a spec"
            exit 0
          else
            echo "‚ö†Ô∏è  PR should link to an issue (Closes #XX) or reference a spec (SPEC-XX)"
            echo "This ensures traceability in SPEC-driven development"
            echo "Allowing PR to proceed for initial setup..."
            exit 0
          fi

  validate-spec-format:
    name: Validate Spec Format
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for spec files in PR
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          SPEC_FILES=$(echo "$CHANGED_FILES" | grep "^specs/SPEC-.*\.md$" || true)

          if [ -z "$SPEC_FILES" ]; then
            echo "‚ÑπÔ∏è No actual spec files (SPEC-*.md) changed in this PR"
            exit 0
          fi

          echo "üìã Validating spec files:"
          echo "$SPEC_FILES"

          # Validate each spec file contains required sections
          for spec_file in $SPEC_FILES; do
            if [ ! -f "$spec_file" ]; then
              continue
            fi

            echo "Checking $spec_file..."

            # Check for required sections
            required_sections=("## Overview" "## Requirements" "## Acceptance Criteria" "## Status")
            missing_sections=()

            for section in "${required_sections[@]}"; do
              if ! grep -q "$section" "$spec_file"; then
                missing_sections+=("$section")
              fi
            done

            if [ ${#missing_sections[@]} -gt 0 ]; then
              echo "‚ùå $spec_file is missing required sections:"
              printf '%s\n' "${missing_sections[@]}"
              exit 1
            fi

            echo "‚úÖ $spec_file has all required sections"
          done

          echo "‚úÖ All spec files are properly formatted"
